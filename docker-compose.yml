version: '3.8'

services:
  # Node.js 后端服务
  app:
    build: .
    container_name: media-share-app
    restart: unless-stopped
    ports:
      - "3000:3000"  # 将容器的3000端口映射到主机的3000端口
    volumes:
      # 挂载数据目录用于持久化存储
      - media-data:/app/data
      - media-uploads:/app/uploads
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - VOLC_TTS_APP_ID=${VOLC_TTS_APP_ID}
      - VOLC_TTS_ACCESS_KEY=${VOLC_TTS_ACCESS_KEY}
      - VOLC_TTS_ACCESS_TOKEN=${VOLC_TTS_ACCESS_TOKEN}
      - VOLC_VOICECLONE_RESOURCE_ID=${VOLC_VOICECLONE_RESOURCE_ID}
      - VOLC_VOICECLONE_SPEAKER_ID=${VOLC_VOICECLONE_SPEAKER_ID}
      - VOLC_VOICECLONE_ALLOWED_SPEAKER_IDS=${VOLC_VOICECLONE_ALLOWED_SPEAKER_IDS}
      - VOLC_TTS_RESOURCE_ID_V2=${VOLC_TTS_RESOURCE_ID_V2}
      - VOLC_TTS_RESOURCE_ID_V1=${VOLC_TTS_RESOURCE_ID_V1}
      - VOLC_TTS_RESOURCE_ID_ICL1=${VOLC_TTS_RESOURCE_ID_ICL1}
      - VOLC_TTS_RESOURCE_ID_ICL2=${VOLC_TTS_RESOURCE_ID_ICL2}
      - VOLC_TTS_MODEL_V2=${VOLC_TTS_MODEL_V2}
    networks:
      - media-share-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: media-share-nginx
    restart: unless-stopped
    ports:
      - "8580:80"  # 将容器的80端口映射到主机的8080端口
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro  # 挂载nginx配置文件
      - ./public:/usr/share/nginx/html:ro  # 挂载静态文件
    depends_on:
      - app
    networks:
      - media-share-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  media-share-network:
    driver: bridge

volumes:
  media-data:
    driver: local
  media-uploads:
    driver: local
